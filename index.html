<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Elektroniczna Karta Pr√≥by Hamulca</title>
  <meta name="theme-color" content="#007acc">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
      color: #222;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    .panel {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .panel h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #005a9e;
    }
    label {
      display: block;
      margin: 10px 0;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
    }
    button {
      padding: 10px 16px;
      margin-top: 10px;
      background: #007acc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .error {
      color: #b00020;
      font-weight: 600;
    }
    .success {
      color: #0a7a2f;
      font-weight: 600;
    }
    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px) {
      .row-2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<h2>Karta pr√≥by hamulca üöÜ</h2>

<div class="panel">
  <h3>Dane og√≥lne</h3>
  <div class="row-2">
    <label>Miejsce wykonania pr√≥by:
      <input id="miejsce" type="text" autocomplete="off">
    </label>
    <label>Data (DD.MM.YYYY):
      <input id="data" type="text" inputmode="numeric" placeholder="DD.MM.RRRR">
    </label>
    <label>Godzina (HH:MM):
      <input id="godzina" type="text" inputmode="numeric" placeholder="HH:MM">
    </label>
    <label>Osoba wystawiajƒÖca kartƒô:
      <input id="osobaWystawiajaca" type="text" autocomplete="off">
    </label>
    <label>Pr√≥bƒô wykonano z:
      <select id="probaZ">
        <option value="">-- wybierz --</option>
        <option value="Lokomotywa prowadzƒÖca">Lokomotywa prowadzƒÖca</option>
        <option value="Inna lokomotywa">Inna lokomotywa</option>
        <option value="UrzƒÖdzenie stacjonarne">UrzƒÖdzenie stacjonarne</option>
      </select>
    </label>
    <label id="oznaczenieLok" style="display:none;">Oznaczenie lokomotywy:
      <input id="lokomotywa" type="text" autocomplete="off">
    </label>
    <label id="stanowisko" style="display:none;">Numer stanowiska:
      <input id="stanowiskoNr" type="text" autocomplete="off">
    </label>
    <label>Numer pierwszego wagonu:
      <input id="zaLok1" type="text" autocomplete="off">
    </label>
    <label>Numer drugiego wagonu:
      <input id="zaLok2" type="text" autocomplete="off">
    </label>
    <label>Numer przedostatniego wagonu:
      <input id="koniec1" type="text" autocomplete="off">
    </label>
    <label>Numer ostatniego wagonu:
      <input id="koniec2" type="text" autocomplete="off">
    </label>
    <label>Osoba wykonujƒÖca pr√≥bƒô:
      <input id="osobaProba" type="text" autocomplete="off">
    </label>
    <label>Maszynista:
      <input id="maszynista" type="text" autocomplete="off">
    </label>
    <label>Kierownik pociƒÖgu:
      <input id="kierownik" type="text" autocomplete="off">
    </label>
  </div>
</div>

<div class="panel">
  <h3>Pr√≥ba hamulca</h3>
  <div class="row-2">
    <label>Masa og√≥lna sk≈Çadu [t]:
      <input id="masaSkladu" type="number" step="1" min="0">
    </label>
    <label>Masa og√≥lna pociƒÖgu [t]:
      <input id="masaPociagu" type="number" step="1" min="0">
    </label>
    <label>Masa hamujƒÖca rzeczywista [t]:
      <input id="mhr" type="number" step="1" min="0">
    </label>
    <label>Procent wymagany [%]:
      <input id="pw" type="number" step="1" min="0" max="100">
    </label>
    <label>Ci≈õnienie przewodu g≈Ç√≥wnego [MPa]:
      <input id="cisnienieGl" type="number" step="0.01" min="0">
    </label>
    <label>Ci≈õnienie przewodu dodatkowego [MPa]:
      <input id="cisnienieDod" type="number" step="0.01" min="0">
    </label>
  </div>
  <button id="btnOblicz" type="button">Oblicz</button>
</div>

<div class="panel">
  <h3>Wyniki</h3>
  <p id="wynik"></p>
  <p id="komunikat"></p>
  <button id="drukujBtn" type="button" disabled>Drukuj</button>
</div>

<script>
  // Pokazywanie p√≥l zale≈ºnych od ≈∫r√≥d≈Ça pr√≥by
  document.getElementById("probaZ").addEventListener("change", function() {
    const v = this.value;
    document.getElementById("oznaczenieLok").style.display =
      (v === "Lokomotywa prowadzƒÖca" || v === "Inna lokomotywa") ? "block" : "none";
    document.getElementById("stanowisko").style.display =
      (v === "UrzƒÖdzenie stacjonarne") ? "block" : "none";
  });

  document.getElementById("btnOblicz").addEventListener("click", oblicz);
  document.getElementById("drukujBtn").addEventListener("click", drukuj);

  function oblicz() {
    const masaSkladu = parseFloat(document.getElementById("masaSkladu").value);
    const masaPociagu = parseFloat(document.getElementById("masaPociagu").value);
    const mhr = parseFloat(document.getElementById("mhr").value);
    const pw = parseFloat(document.getElementById("pw").value);
    const cisGl = parseFloat(document.getElementById("cisnienieGl").value);
    const cisDod = parseFloat(document.getElementById("cisnienieDod").value);

    if (isNaN(masaSkladu) || isNaN(masaPociagu) || isNaN(mhr) || isNaN(pw)) {
      document.getElementById("komunikat").innerHTML = "<span class='error'>Uzupe≈Çnij wszystkie pola!</span>";
      return;
    }

    const Mo = (masaSkladu >= 200) ? masaSkladu : masaPociagu;
    const Mhw = Math.ceil((Mo * pw) / 100);
    const Pr = Math.floor((mhr * 100) / Mo);

    document.getElementById("wynik").innerHTML =
      `Mo: ${Mo} t<br>Mhw: ${Mhw} t<br>Pr: ${Pr}%`;

    let komunikat = "";
    if (Pr < pw) {
      komunikat += "<span class='error'>Dodaj wagony lub zmniejsz prƒôdko≈õƒá!</span><br>";
    } else {
      komunikat += "<span class='success'>Warunki spe≈Çnione ‚úÖ</span><br>";
    }
    if (!isNaN(cisGl) && cisGl !== 0.5) {
      komunikat += "<span class='error'>Sprawd≈∫ dopuszczalne odchylenia przewodu g≈Ç√≥wnego!</span><br>";
    }
    if (!isNaN(cisDod) && (cisDod !== 0.5 && cisDod !== 0.8)) {
      komunikat += "<span class='error'>Sprawd≈∫ dopuszczalne odchylenia przewodu dodatkowego!</span><br>";
    }

    document.getElementById("komunikat").innerHTML = komunikat;
    document.getElementById("drukujBtn").disabled = false;
  }

  function drukuj() {
    const now = new Date();
    const footer = `Wygenerowano: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}<br>Wygenerowano z systemu ESKA by klawinsky & Copilot`;
    const get = id => document.getElementById(id)?.value || "-";
    const wynik = document.getElementById("wynik").innerHTML || "-";

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
      <html>
        <head>
          <meta charset="UTF-8">
          <title>Karta pr√≥by hamulca</title>
          <link rel="stylesheet" href="print.css">
        </head>
        <body>
          <h2>Elektroniczna Karta Pr√≥by Hamulca</h2>
          <table>
            <tr><th>Miejsce wykonania pr√≥by</th><td>${get("miejsce")}</td></tr>
            <tr><th>Data</th><td>${get("data")}</td></tr>
            <tr><th>Godzina</th><td>${get("godzina")}</td></tr>
            <tr><th>Osoba wystawiajƒÖca</th><td>${get("osobaWystawiajaca")}</td></tr>
            <tr class="section-title"><td colspan="2">Dane pr√≥by</td></tr>
            <tr><th>Pr√≥bƒô wykonano z</th><td>${get("probaZ")}</td></tr>
            <tr><th>Oznaczenie lokomotywy</th><td>${get("lokomotywa")}</td></tr>
            <tr><th>Numer stanowiska</th><td>${get("stanowiskoNr")}</td></tr>
            <tr><th>Numery wagon√≥w za lokomotywƒÖ</th><td>${get("zaLok1")}, ${get("zaLok2")}</td></tr>
            <tr><th>Numery wagon√≥w na ko≈Ñcu sk≈Çadu</th><td>${get("koniec1")}, ${get("koniec2")}</td></tr>
            <tr class="section-title"><td colspan="2">Parametry i wyniki</td></tr>
            <tr><th>Masa og√≥lna sk≈Çadu</th><td>${get("masaSkladu")} t</td></tr>
            <tr><th>Masa og√≥lna pociƒÖgu</th><td>${get("masaPociagu")} t</td></tr>
            <tr><th>Masa hamujƒÖca rzeczywista</th><td>${get("mhr")} t</td></tr>
            <tr><th>Procent wymagany</th><td>${get("pw")}%</td></tr>
            <tr><th>Obliczenia (Mo, Mhw, Pr)</th><td>${wynik}</td></tr>
            <tr><th>Ci≈õnienie przewodu g≈Ç√≥wnego</th><td>${get("cisnienieGl")} MPa</td></tr>
            <tr><th>Ci≈õnienie przewodu dodatkowego</th><td>${get("cisnienieDod")} MPa</td></tr>
            <tr class="section-title"><td colspan="2">Podpisy pracownik√≥w</td></tr>
            <tr><th>Osoba wykonujƒÖca pr√≥bƒô</th><td class="signature-line">${get("osobaProba")}</td></tr>
            <tr><th>Maszynista</th><td class="signature-line">${get("maszynista")}</td></tr>
            <tr><th>Kierownik pociƒÖgu</th><td class="signature-line">${get("kierownik")}</td></tr>
          </table>
          <footer>${footer}</footer>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }

  // Rejestracja service workera (opcjonalnie dla PWA/offline)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.error('SW registration failed:', err));
    });
  }
</script>

</body>
</html>
